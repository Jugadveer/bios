{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Course Detail - WealthPlay</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF8560;
            --sidebar-bg: #FFF5F0;
            --text-main: #333;
            --text-light: #777;
            --border: #eee;
            --white: #ffffff;
            --hover-bg: #FFF0EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--white);
        }

        .icon-sidebar {
            width: 60px;
            background-color: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 2;
        }

        .brand-mini {
            font-weight: 800;
            font-size: 12px;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.2;
        }

        .icon-menu-item {
            margin: 15px 0;
            color: #000;
            font-size: 18px;
            cursor: pointer;
            position: relative;
        }

        .icon-menu-item.active::after {
            content: '';
            position: absolute;
            left: -22px;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 3px;
            background-color: var(--primary);
        }

        .nav-sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .nav-header {
            height: 60px;
            min-height: 60px;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .nav-header span {
            margin-right: 8px;
        }

        .menu-group {
            padding: 10px 0;
        }

        .menu-group-topics {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .menu-group-title {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            flex-shrink: 0;
        }

        #topics-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }

        #topics-list::-webkit-scrollbar {
            width: 6px;
        }

        #topics-list::-webkit-scrollbar-track {
            background: transparent;
        }

        #topics-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        #topics-list::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .menu-item {
            padding: 10px 20px 10px 35px;
            font-size: 14px;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-decoration: none;
        }

        .menu-item:hover {
            background-color: #ffeae3;
        }

        .menu-item.active {
            background-color: var(--primary);
            color: white;
        }

        .menu-tag {
            font-size: 10px;
            padding: 2px 4px;
            background-color: #ffccbc;
            color: #d84315;
            border-radius: 3px;
        }

        .menu-item.active .menu-tag {
            background-color: rgba(255,255,255,0.3);
            color: white;
        }

        .tag-orange {
            background-color: var(--primary);
            color: white;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            height: 60px;
            min-height: 60px;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
            flex-shrink: 0;
        }

        .search-bar {
            flex: 1;
            margin: 0 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 35px;
            border-radius: 4px;
            border: none;
            outline: none;
            font-size: 14px;
        }

        .search-bar i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 12px;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }
        
        .header-actions button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .header-actions button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-area {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
            background-color: white;
        }

        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #333;
        }

        .message-row {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
            flex-shrink: 0;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
        }

        .msg-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }

        .msg-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-right: 10px;
        }

        .msg-time {
            font-size: 12px;
            color: #999;
        }

        .msg-text {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }

        .reaction-bar {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .reaction {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .reaction.orange {
            background-color: #FFF0EB;
            color: var(--primary);
        }

        .attachment-card {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
            width: fit-content;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .att-icon {
            width: 36px;
            height: 36px;
            background: #FF8560;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 12px;
        }

        .att-info h4 {
            font-size: 13px;
            font-weight: 600;
        }

        .att-info span {
            font-size: 11px;
            color: #999;
        }

        .att-action {
            margin-left: 20px;
            color: #555;
            cursor: pointer;
        }

        .att-footer {
            margin-top: 5px;
            font-size: 11px;
            color: #777;
            display: flex;
            gap: 15px;
        }
        
        .att-footer a {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }

        .att-footer a:hover {
            text-decoration: underline;
        }

        .att-footer i {
            margin-right: 5px;
        }

        .input-area {
            padding: 20px 30px;
            border-top: 1px solid #eee;
        }

        .input-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .input-field {
            width: 100%;
            border: none;
            outline: none;
            font-size: 14px;
            padding: 10px 5px;
            color: #333;
            resize: none;
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            padding: 0 5px;
        }

        .left-icons i {
            color: #555;
            font-size: 16px;
            margin-right: 15px;
            cursor: pointer;
        }

        .send-btn {
            color: #333;
            cursor: pointer;
        }

        .new-inquiry-btn {
            padding: 15px 20px;
            font-size: 13px;
            color: #333;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-top: auto; 
            border-top: 1px solid #eee;
        }
        
        .new-inquiry-btn i {
            margin-right: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        /* Login/Signup Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--primary);
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-primary {
            flex: 1;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #EA580C;
        }
        
        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }
        
        .auth-switch a {
            color: var(--primary);
            cursor: pointer;
            text-decoration: none;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        /* New Inquiry Chat Window */
        .inquiry-chat-window {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 9998;
            flex-direction: column;
        }
        
        .inquiry-chat-window.show {
            display: flex;
        }
        
        .inquiry-chat-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inquiry-chat-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .inquiry-chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .inquiry-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f8f8;
        }
        
        .inquiry-chat-input-area {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .inquiry-chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .inquiry-chat-send {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <nav class="icon-sidebar">
        <div class="brand-mini">WE<br>ALT</div>
        <div class="icon-menu-item"><i class="fas fa-user"></i></div>
        <div class="icon-menu-item active"><i class="fas fa-comment-dots"></i></div>
        <div class="icon-menu-item"><i class="fas fa-bell"></i></div>
    </nav>

    <aside class="nav-sidebar">
        <div class="nav-header">
            <span>WealthPlay</span> <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
        </div>

        <div class="menu-group">
            <div class="menu-group-title">Your Guidance</div>
        </div>
        
        <div class="menu-group menu-group-topics">
            <div class="menu-group-title">
                <span>Recent Topics</span>
                <i class="fas fa-chevron-up"></i>
            </div>
            <div id="topics-list">
                <!-- Topics will be loaded here -->
            </div>
        </div>

        <div class="menu-group">
            <div class="menu-group-title">
                <span>Group Sessions</span>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>

        <div class="new-inquiry-btn" id="new-inquiry-btn">
            <i class="fas fa-pen"></i> New Inquiry
        </div>
    </aside>

    <main class="main-content">
        <header>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search for advice">
            </div>
            <div class="header-actions" id="header-actions">
                {% if user.is_authenticated %}
                    <form method="post" action="/course/auth/logout/" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" style="background: none; border: none; color: white; cursor: pointer; font-size: 14px; font-weight: 600; margin-left: 20px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </form>
                {% endif %}
            </div>
        </header>

        <div class="chat-area" id="chatFeed">
            <div class="section-title" id="course-title">Loading course...</div>
            <div id="messages-container">
                <div class="loading">Loading course content...</div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <textarea class="input-field" id="chat-input" rows="1" placeholder="Type a new question..."></textarea>
                <div class="input-actions">
                    <div class="left-icons">
                        <i class="fas fa-pen"></i>
                        <i class="fas fa-paperclip"></i>
                        <i class="fas fa-link"></i>
                        <i class="fas fa-microphone"></i>
                        <i class="far fa-smile"></i>
                    </div>
                    <div class="send-btn" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Extract courseId from URL path like /course/t01/ or /course/basic-money/
        function extractCourseId() {
            const pathParts = window.location.pathname.split('/').filter(p => p);
            const courseIndex = pathParts.indexOf('course');
            return courseIndex !== -1 && pathParts[courseIndex + 1] ? pathParts[courseIndex + 1] : '';
        }
        
        let courseId = extractCourseId();
        console.log('Extracted courseId:', courseId, 'from path:', window.location.pathname);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1] || '';
        
        let currentCourse = null;
        let allCourses = [];
        let currentModule = null;

        async function loadAllCourses() {
            try {
                const response = await fetch('/api/courses/json/');
                const data = await response.json();
                allCourses = Array.isArray(data) ? data : (data.value || data.courses || []);
                return allCourses;
            } catch (error) {
                console.error('Error loading courses:', error);
                return [];
            }
        }

        async function loadCourse() {
            try {
                // Update courseId from URL in case it changed
                courseId = extractCourseId();
                console.log('Loading course with ID:', courseId);
                
                if (!courseId) {
                    throw new Error('Course ID is empty');
                }
                
                const response = await fetch(`/api/courses/json/${courseId}/`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.error || `HTTP error! status: ${response.status}`;
                    console.error('Course API error:', errorMsg);
                    
                    // If 404, try loading first course instead
                    if (response.status === 404) {
                        const courses = await loadAllCourses();
                        if (courses && courses.length > 0) {
                            const firstCourseId = courses[0].id;
                            console.log(`Course '${courseId}' not found, redirecting to first course: ${firstCourseId}`);
                            switchCourse(firstCourseId);
                            return;
                        }
                    }
                    
                    throw new Error(errorMsg);
                }
                
                const course = await response.json();
                console.log('Loaded course:', course);
                
                if (course.error) {
                    document.getElementById('messages-container').innerHTML = 
                        `<div class="message-row"><div class="message-content"><div class="msg-text">${course.error}</div></div></div>`;
                    return;
                }
                
                currentCourse = course;
                currentModule = course.modules && course.modules.length > 0 ? course.modules[0] : null;
                document.getElementById('page-title').textContent = `${course.title} - WealthPlay`;
                document.getElementById('course-title').textContent = course.title;
                
                // Load all courses for sidebar
                const courses = await loadAllCourses();
                renderSidebar(courses, course.id);
                
                // Load topic-specific chat history first
                const hasChatHistory = await loadTopicChatHistory(course.id, currentModule?.id || '');
                
                // Render initial course content (only if no chat history exists)
                if (!hasChatHistory) {
                    renderCourseContent(course);
                }
                
            } catch (error) {
                console.error('Error loading course:', error);
                document.getElementById('messages-container').innerHTML = 
                    '<div class="message-row"><div class="message-content"><div class="msg-text">Error loading course. Please try again later.</div></div></div>';
            }
        }
        
        function renderSidebar(courses, activeId) {
            const topicsList = document.getElementById('topics-list');
            topicsList.innerHTML = courses.map(c => `
                <div class="menu-item ${c.id === activeId ? 'active' : ''}" 
                     onclick="switchCourse('${c.id}')" 
                     style="cursor: pointer;">
                    <span>${c.title}</span>
                </div>
            `).join('');
        }
        
        // Load topic-specific chat history
        async function loadTopicChatHistory(courseId, moduleId) {
            try {
                const url = moduleId 
                    ? `/api/chat/topic/${courseId}/${moduleId}/`
                    : `/api/chat/topic/${courseId}/`;
                
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.messages && data.messages.length > 0) {
                        // Clear current messages and restore chat history
                        document.getElementById('messages-container').innerHTML = '';
                        data.messages.forEach(msg => {
                            const isUser = msg.sender === 'user';
                            addMessage(
                                msg.sender === 'nex' ? 'Nex' : 'User',
                                msg.text,
                                msg.time_display || new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                                isUser,
                                false
                            );
                        });
                        document.getElementById('chatFeed').scrollTop = document.getElementById('chatFeed').scrollHeight;
                        return true; // Chat history loaded
                    }
                }
                return false; // No chat history
            } catch (error) {
                console.error('Error loading topic chat history:', error);
                return false;
            }
        }

        // Instant course switching (SPA-like)
        async function switchCourse(newCourseId) {
            console.log('Switching to course:', newCourseId);
            // Update global courseId variable
            courseId = newCourseId;
            
            // Update URL without reload
            window.history.pushState({courseId: newCourseId}, '', `/course/${newCourseId}/`);
            
            // Load course instantly
            currentCourse = null;
            currentModule = null;
            
            // Clear messages before loading new course
            document.getElementById('messages-container').innerHTML = '';
            
            await loadCourse();
        }
        
        function renderCourseContent(course) {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            // Add welcome message (removed WISE)
            addMessage('Nex', 'What would you like help with today?', '09:16 AM');
            
            // Add initial user question and response if available
            if (currentModule && currentModule.fixed_qna && currentModule.fixed_qna.length > 0) {
                const firstQA = currentModule.fixed_qna[0];
                addMessage('User', firstQA.q, '09:16 AM', true);
                addMessage('Nex', firstQA.a, '09:17 AM', false, true);
            }
        }
        
        function addMessage(sender, text, time, showReactions = false, showAttachment = false) {
            const messagesContainer = document.getElementById('messages-container');
            const messageRow = document.createElement('div');
            messageRow.className = 'message-row';
            
            // Determine avatar
            let avatarContent = '';
            let avatarClass = '';
            if (sender === 'Nex') {
                avatarContent = '<img src="https://randomuser.me/api/portraits/men/85.jpg" alt="Nex">';
            } else {
                avatarContent = '<img src="https://randomuser.me/api/portraits/men/22.jpg" alt="User">';
            }
            
            let attachmentHTML = '';
            if (showAttachment && currentModule) {
                attachmentHTML = `
                    <div class="attachment-card">
                        <div class="att-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="att-info">
                            <h4>${currentModule.title || 'Investment'}</h4>
                            <span>${time} â€¢ 15 MB</span>
                        </div>
                        <div class="att-action"><i class="fas fa-cloud-download-alt"></i></div>
                    </div>
                    <div class="att-footer">
                        <a href="#" class="overview-link" data-module-id="${currentModule.id}">
                            <i class="fas fa-info-circle"></i> Overview
                        </a>
                        <a href="#" class="explain-link" data-module-id="${currentModule.id}">
                            <i class="far fa-file-alt"></i> Explain
                        </a>
                    </div>
                `;
            }
            
            messageRow.innerHTML = `
                <div class="avatar">${avatarContent}</div>
                <div class="message-content">
                    <div class="msg-header">
                        <span class="msg-name">${sender}</span>
                        <span class="msg-time">${time}</span>
                    </div>
                    <div class="msg-text">${text}</div>
                    ${showReactions ? `
                        <div class="reaction-bar">
                            <div class="reaction orange"><i class="fas fa-lightbulb"></i></div>
                            <div class="reaction"><i class="fas fa-plus"></i></div>
                        </div>
                    ` : ''}
                    ${attachmentHTML}
                </div>
            `;
            
            messagesContainer.appendChild(messageRow);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add event listeners for Overview and Explain buttons
            if (showAttachment) {
                const overviewLink = messageRow.querySelector('.overview-link');
                const explainLink = messageRow.querySelector('.explain-link');
                
                if (overviewLink) {
                    overviewLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleOverviewClick(currentModule.id);
                    });
                }
                
                if (explainLink) {
                    explainLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleExplainClick(currentModule.id);
                    });
                }
            }
        }
        
        async function handleOverviewClick(moduleId) {
            if (!currentCourse || !moduleId) return;
            
            const question = `Give me an overview of ${currentModule?.title || 'this topic'}`;
            await askMentor(question, 'Nex');
        }
        
        async function handleExplainClick(moduleId) {
            if (!currentCourse || !moduleId) return;
            
            const question = `Explain ${currentModule?.title || 'this topic'} in detail`;
            await askMentor(question, 'Nex');
        }
        
        async function askMentor(question, sender = 'Nex') {
            // Add user message
            addMessage('User', question, new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), true);
            
            // Show typing indicator
            const typingRow = document.createElement('div');
            typingRow.className = 'message-row';
            typingRow.innerHTML = `
                <div class="avatar"><img src="https://randomuser.me/api/portraits/men/85.jpg" alt="Nex"></div>
                <div class="message-content">
                    <div class="msg-header">
                        <span class="msg-name">${sender}</span>
                        <span class="msg-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="msg-text">Thinking...</div>
                </div>
            `;
            document.getElementById('messages-container').appendChild(typingRow);
            document.getElementById('chatFeed').scrollTop = document.getElementById('chatFeed').scrollHeight;
            
            try {
                const response = await fetch('/api/chat/mentor/respond/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        course_id: currentCourse.id,
                        module_id: currentModule?.id || (currentCourse.modules && currentCourse.modules[0]?.id) || '',
                        question: question
                    })
                });
                
                const data = await response.json();
                document.getElementById('messages-container').removeChild(typingRow);
                
                const answer = data.reply || data.answer || 'Sorry, I couldn\'t generate a response.';
                addMessage(sender, answer, new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                
            } catch (error) {
                console.error('Error asking mentor:', error);
                document.getElementById('messages-container').removeChild(typingRow);
                addMessage(sender, 'Sorry, I encountered an error. Please try again.', new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            }
        }
        
        // Send message handler
        document.getElementById('send-button').addEventListener('click', () => {
            const input = document.getElementById('chat-input');
            const question = input.value.trim();
            if (question) {
                askMentor(question);
                input.value = '';
            }
        });
        
        // Enter key handler
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('send-button').click();
            }
        });
        
        // Auto-resize textarea
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Load course on page load
        if (courseId) {
            loadCourse();
        } else {
            // If no courseId, try to load first course
            loadAllCourses().then(courses => {
                if (courses && courses.length > 0) {
                    const firstCourseId = courses[0].id;
                    console.log('No courseId in URL, loading first course:', firstCourseId);
                    // Switch to first course
                    switchCourse(firstCourseId);
                } else {
                    document.getElementById('messages-container').innerHTML = 
                        '<div class="message-row"><div class="message-content"><div class="msg-text">No courses available. Please check the server.</div></div></div>';
                }
            });
        }
    </script>
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login</h2>
                <span class="close" onclick="closeModal('loginModal')">&times;</span>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Login</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('loginModal'); openModal('signupModal')">Sign Up</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sign Up</h2>
                <span class="close" onclick="closeModal('signupModal')">&times;</span>
            </div>
            <form id="signupForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Sign Up</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('signupModal'); openModal('loginModal')">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Inquiry Chat Window -->
    <div id="inquiryChatWindow" class="inquiry-chat-window">
        <div class="inquiry-chat-header">
            <h3>WealthPlay Assistant</h3>
            <button class="inquiry-chat-close" onclick="closeInquiryChat()">&times;</button>
        </div>
        <div class="inquiry-chat-messages" id="inquiryMessages">
            <div class="message-row">
                <div class="avatar"><img src="https://randomuser.me/api/portraits/men/85.jpg" alt="Assistant"></div>
                <div class="message-content">
                    <div class="msg-header">
                        <span class="msg-name">Assistant</span>
                    </div>
                    <div class="msg-text">Hello! I'm your WealthPlay assistant. How can I help you today?</div>
                </div>
            </div>
        </div>
        <div class="inquiry-chat-input-area">
            <input type="text" class="inquiry-chat-input" id="inquiryInput" placeholder="Type your question..." onkeypress="if(event.key==='Enter') sendInquiryMessage()">
            <button class="inquiry-chat-send" onclick="sendInquiryMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        // Auth state check
        {% if not user.is_authenticated %}
            window.addEventListener('DOMContentLoaded', () => {
                openModal('loginModal');
            });
        {% endif %}
        
        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Login form handler
        document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/course/auth/login/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                alert('Error logging in. Please try again.');
            }
        });
        
        // Signup form handler
        document.getElementById('signupForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/course/auth/signup/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || 'Signup failed');
                }
            } catch (error) {
                alert('Error signing up. Please try again.');
            }
        });
        
        // Logout is handled by form submission in the header
        
        // New Inquiry chat window
        document.getElementById('new-inquiry-btn')?.addEventListener('click', () => {
            const chatWindow = document.getElementById('inquiryChatWindow');
            chatWindow.classList.add('show');
        });
        
        function closeInquiryChat() {
            document.getElementById('inquiryChatWindow').classList.remove('show');
        }
        
        async function sendInquiryMessage() {
            const input = document.getElementById('inquiryInput');
            const question = input.value.trim();
            if (!question) return;
            
            const messagesDiv = document.getElementById('inquiryMessages');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'message-row';
            userMsg.innerHTML = `
                <div class="avatar"><img src="https://randomuser.me/api/portraits/men/22.jpg" alt="User"></div>
                <div class="message-content">
                    <div class="msg-header">
                        <span class="msg-name">You</span>
                    </div>
                    <div class="msg-text">${question}</div>
                </div>
            `;
            messagesDiv.appendChild(userMsg);
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Add typing indicator
            const typingMsg = document.createElement('div');
            typingMsg.className = 'message-row';
            typingMsg.id = 'typing-indicator';
            typingMsg.innerHTML = `
                <div class="avatar"><img src="https://randomuser.me/api/portraits/men/85.jpg" alt="Assistant"></div>
                <div class="message-content">
                    <div class="msg-text">Thinking...</div>
                </div>
            `;
            messagesDiv.appendChild(typingMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch('/api/chat/mentor/inquiry/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ question: question })
                });
                
                const data = await response.json();
                messagesDiv.removeChild(typingMsg);
                
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'message-row';
                assistantMsg.innerHTML = `
                    <div class="avatar"><img src="https://randomuser.me/api/portraits/men/85.jpg" alt="Assistant"></div>
                    <div class="message-content">
                        <div class="msg-header">
                            <span class="msg-name">Assistant</span>
                        </div>
                        <div class="msg-text">${data.reply || data.answer || 'Sorry, I couldn\'t generate a response.'}</div>
                    </div>
                `;
                messagesDiv.appendChild(assistantMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
            } catch (error) {
                console.error('Error:', error);
                messagesDiv.removeChild(typingMsg);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message-row';
                errorMsg.innerHTML = `
                    <div class="avatar"><img src="https://randomuser.me/api/portraits/men/85.jpg" alt="Assistant"></div>
                    <div class="message-content">
                        <div class="msg-text">Sorry, I encountered an error. Please try again.</div>
                    </div>
                `;
                messagesDiv.appendChild(errorMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        // Browser back/forward handling for SPA-like navigation
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.courseId) {
                switchCourse(e.state.courseId);
            }
        });
    </script>
    
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
</body>
</html>
